name: Build and Release Books

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Configurar Rust e Cache (Otimizado para o wrapper)
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: wrapper -> target

      # 2. Instalar mdBook v0.5.2 (Bin√°rio nativo Windows)
      - name: Install mdBook v0.5.2
        shell: bash
        run: |
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.5.2/mdbook-v0.5.2-x86_64-pc-windows-msvc.zip -o mdbook.zip
          unzip mdbook.zip
          mv mdbook.exe /usr/bin/
          mdbook --version

      # 3. Consolidar todos os livros e gerar os HTMLs
      # O script build_books.sh cria as pastas /book dentro de cada diret√≥rio
      - name: Consolidate Books
        shell: bash
        run: |
          chmod +x build_books.sh
          ./build_books.sh

      # 4. Loop de Compila√ß√£o dos Execut√°veis
      # Compila um por um, injetando o HTML e o √çcone correspondente
      - name: Build All Executables
        shell: bash
        env:
          CARGO_INCREMENTAL: 1
        run: |
          BOOKS=("financeiro" "ambiental" "sinir" "administrativo" "gerencial")
          
          for book in "${BOOKS[@]}"; do
            echo "-------------------------------------------------------"
            echo "üõ†Ô∏è Compilando Execut√°vel: $book"
            echo "-------------------------------------------------------"
            
            # Limpa e prepara a pasta de assets que o RustEmbed vai ler
            rm -rf wrapper/temp_book_src
            mkdir -p wrapper/temp_book_src
            
            # Copia o HTML gerado para a pasta de embutimento
            cp -r books/$book/book/* wrapper/temp_book_src/
            
            # Define o √≠cone e compila
            export BOOK_ICON="../icons/$book.ico"
            cd wrapper
            cargo build --release
            
            # Move o bin√°rio final para a raiz com o nome correto
            mv target/release/manual_interno.exe ../$book.exe
            cd ..
          done

      # 5. Publicar na Release do GitHub
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            financeiro.exe
            ambiental.exe
            sinir.exe
            administrativo.exe
            gerencial.exe
          body: "Compila√ß√£o autom√°tica de manuais - Vers√£o ${{ github.ref_name }}"
          generate_release_notes: true
